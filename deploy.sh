#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç root
if [ "$EUID" -ne 0 ]; then
    print_error "–°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç root"
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: sudo ./deploy.sh"
    exit 1
fi

print_info "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ VK Bot –Ω–∞ VPS"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_DIR="/root/VKbotMain"
SERVICE_NAME="google-vk-bot"

# 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
print_info "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É..."
apt update && apt upgrade -y

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
print_info "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã..."
apt install -y python3 python3-pip python3-venv git curl wget htop nano

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –ø—Ä–æ–µ–∫—Ç
if [ -d "$PROJECT_DIR" ]; then
    print_warning "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –û–±–Ω–æ–≤–ª—è–µ–º..."
    cd "$PROJECT_DIR"
    git pull origin main
else
    print_info "üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
    git clone https://github.com/evseew/VKbotMain.git "$PROJECT_DIR"
    cd "$PROJECT_DIR"
fi

# 4. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
print_info "üêç –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
python3 -m venv new_venv
source new_venv/bin/activate

# 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
print_info "üìã –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install --upgrade pip
pip install -r requirements.txt

# 6. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
print_info "‚öôÔ∏è  –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f ".env" ]; then
    print_warning "–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—ë–º –∏–∑ —à–∞–±–ª–æ–Ω–∞..."
    cp .env.example .env
    print_warning "‚ùó –í–ê–ñ–ù–û: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º–∏ API –∫–ª—é—á–∞–º–∏:"
    print_warning "   nano $PROJECT_DIR/.env"
    echo
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Google —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∫–ª—é—á–∞
if [ ! -f "service-account-key.json" ]; then
    print_warning "‚ùó –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª service-account-key.json –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞"
    echo
fi

# 7. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
print_info "üìÅ –°–æ–∑–¥–∞—ë–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
mkdir -p logs logs/context_logs local_vector_db history_vk

# 8. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
print_info "üîê –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
chown -R root:root "$PROJECT_DIR"
chmod +x *.sh

# 9. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd —Å–ª—É–∂–±—ã
print_info "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º systemd —Å–ª—É–∂–±—É..."

# –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç–∏ –≤ service —Ñ–∞–π–ª–µ
sed -i "s|/root/GoogleVKBot|$PROJECT_DIR|g" google-vk-bot.service

# –ö–æ–ø–∏—Ä—É–µ–º service —Ñ–∞–π–ª
cp google-vk-bot.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable "$SERVICE_NAME"

# 10. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
print_info "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..."
./control.sh check

print_success "üéâ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo
print_info "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª .env: nano $PROJECT_DIR/.env"
echo "2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª service-account-key.json –≤ $PROJECT_DIR"
echo "3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: ./control.sh start"
echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: ./control.sh status"
echo "5. –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: ./control.sh logs"
echo
print_info "üìñ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º:"
echo "‚Ä¢ –ó–∞–ø—É—Å–∫: ./control.sh start"
echo "‚Ä¢ –û—Å—Ç–∞–Ω–æ–≤–∫–∞: ./control.sh stop"
echo "‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: ./control.sh restart"
echo "‚Ä¢ –°—Ç–∞—Ç—É—Å: ./control.sh status"
echo "‚Ä¢ –õ–æ–≥–∏: ./control.sh logs" 