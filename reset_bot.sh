#!/bin/bash

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_DIR="$SCRIPT_DIR/logs"
CONFIG_DIR="$SCRIPT_DIR/logs/context_logs"

# –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
echo "üîÑ –ù–∞—á–∏–Ω–∞—é –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –±–æ—Ç–∞: $(date)"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ —á–µ—Ä–µ–∑ systemd, –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω –∫–∞–∫ —Å–µ—Ä–≤–∏—Å
if systemctl is-active --quiet google-vk-bot; then
    echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–µ—Ä–≤–∏—Å –±–æ—Ç–∞..."
    sudo systemctl stop google-vk-bot
else
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é, –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω –∫–∞–∫ –ø—Ä–æ—Ü–µ—Å—Å
    if [ -f "$SCRIPT_DIR/bot.pid" ]; then
        echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞..."
        "$SCRIPT_DIR/stop_bot.sh"
    fi
fi

# –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
echo "üßπ –£–¥–∞–ª—è—é —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤..."
mkdir -p "$LOG_DIR"
mkdir -p "$CONFIG_DIR"
rm -f "$LOG_DIR/bot.log"
rm -f "$CONFIG_DIR"/*

# –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
echo "üóëÔ∏è –£–¥–∞–ª—è—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã OpenAI..."
# –ó–¥–µ—Å—å –Ω–∞–º –Ω–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã —Ñ–∏–∑–∏—á–µ—Å–∫–∏, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ —á–µ—Ä–µ–∑ systemd
if systemctl list-unit-files | grep -q google-vk-bot; then
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞ —á–µ—Ä–µ–∑ systemd..."
    sudo systemctl start google-vk-bot
    sleep 3
    STATUS=$(systemctl is-active google-vk-bot)
    if [ "$STATUS" = "active" ]; then
        echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞! –°—Ç–∞—Ç—É—Å: $STATUS"
        echo "üìã –õ–æ–≥ –æ—à–∏–±–∫–∏:"
        sudo journalctl -u google-vk-bot -n 20
    fi
else
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é..."
    "$SCRIPT_DIR/start_bot.sh"
fi

echo "‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å —á–∏—Å—Ç–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π: $(date)"
echo "–¢–µ–ø–µ—Ä—å –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏ –Ω–∞—á–Ω—É—Ç—Å—è —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞!" 